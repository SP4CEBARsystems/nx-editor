<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>LowRes NX</title>
    <style>
    body {
      background-color: #000;
      margin: 0;
      padding: 0;
    }
    .emscripten_border {
    }
    .emscripten {
      display: block;
      margin: auto;
    }
    </style>
  </head>
  <body>
    <div class="emscripten_border">
      <canvas class="emscripten" id="canvas" oncontextmenu="event.preventDefault()" onmousedown="window.focus()"></canvas>
    </div>

    <script type='text/javascript'>
      const params = new URLSearchParams(window.location.search);
      const p = params.get("p");
      console.log(p);

      const fetchTextFile = async (path = './example.txt') => {
        return fetch(path)  // File must be in the same directory as your HTML/JS
          .then(response => response.text())
      }

      const createFilesInFS = () => {
        // FS.writeFile('/Gfx Designer 2.0.nx', gfxDesignerBytes);

        fetchTextFile('./Disk.nx')
          .then(text => {
            console.log('File content as string:\n', text);
            // const text = `
            // #1:MAIN PALETTES
            // 01
            // `;
            const encoder = new TextEncoder();
            const diskBytes = encoder.encode(text); // Uint8Array
            FS.writeFile('/Disk.nx', diskBytes);
            setTimeout(readFilesFromFS, 5000);
          })
          .catch(error => {
            console.error('Failed to load file:', error);
          });
      }
      const readFilesFromFS = () => {
        console.log(FS.readdir('/'));
        console.log(FS.root);
        console.log(FS.root.contents);
        const files = [
          FS.readFile(p.replace(/\/\//g, "/")),
          // FS.readFile('/Gfx Designer 2.0.nx'),
          FS.readFile('/Disk.nx'),
        ];
        console.log(files);
        const decoder = new TextDecoder("utf-8");
        const texts = files.map((file) => decoder.decode(file));
        console.log(texts); // Output: "'TITLE:  
      }

      setTimeout(createFilesInFS, 5000);

      var Module = {
        canvas: document.getElementById('canvas'),
        arguments: [
          "Gfx Designer 2.0.nx",
          "Disk.nx",
          p,
        ],
        print: function(t) {
          console.log(t);
        },
        printErr: function(t) {
          console.log(t);
        }
      };
      function onKeyDown_blocker(event) {
        event = event || window.event;
        if (event.keyCode == 37 || event.keyCode == 38 || event.keyCode == 39 || event.keyCode == 40) {
          if (event.preventDefault) event.preventDefault();
        }
      }
      document.addEventListener('keydown', onKeyDown_blocker, false);
    </script>
    <script async type="text/javascript" src="LowResNX120.js"></script>
  </body>
</html>
